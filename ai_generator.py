import os
import random
from openai import OpenAI
from datetime import date

client = OpenAI()

def generate_daily_energy():
    """Generate daily energy with astro background and tarot card"""
    today = date.today().strftime("%d.%m.%Y")
    
    prompt = f"""–¢—ã ‚Äî –º—è–≥–∫–∏–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –≥–∏–¥ –¥–ª—è –∂–µ–Ω—â–∏–Ω. –°–æ–∑–¥–∞–π —ç–Ω–µ—Ä–≥–∏—é –¥–Ω—è –Ω–∞ {today}.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞:
üåô –ê—Å—Ç—Ä–æ-—Ñ–æ–Ω: [1 –∫–æ—Ä–æ—Ç–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ–± —ç–Ω–µ—Ä–≥–∏–∏ –¥–Ω—è]

–ö–ª—é—á –¥–Ω—è: [2-3 –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é]

üÉè –ö–∞—Ä—Ç–∞ –¥–Ω—è: ¬´[–Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã –¢–∞—Ä–æ]¬ª
–°–º—ã—Å–ª: [1-2 –ø—Ä–æ—Å—Ç—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è]

‚ú® –ú—è–≥–∫–∏–π —Å–æ–≤–µ—Ç: [1 –ø—Ä–∞–∫—Ç–∏—á–Ω–æ–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ]

–í–æ–ø—Ä–æ—Å –¥–ª—è –¥–Ω–µ–≤–Ω–∏–∫–∞: [1 —Ä–µ—Ñ–ª–µ–∫—Å–∏–≤–Ω—ã–π –≤–æ–ø—Ä–æ—Å]

–¢–æ–Ω: —Ç—ë–ø–ª—ã–π, –∂–µ–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π, –±–µ–∑ —Å—Ç—Ä–∞—Ö–∞ –∏ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π. –ü–æ–º–Ω–∏: —Ç—ã –ø–æ–º–æ–≥–∞–µ—à—å —É—Å–ª—ã—à–∞—Ç—å —Å–µ–±—è, –∞ –Ω–µ –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—à—å —Å—É–¥—å–±—É."""

    response = client.chat.completions.create(
        model="gpt-4.1-mini",
        messages=[
            {"role": "system", "content": "–¢—ã ‚Äî –º—è–≥–∫–∏–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –≥–∏–¥, —Å–æ–∑–¥–∞—é—â–∏–π –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≥–Ω–æ–∑—ã —Å –∫–∞—Ä—Ç–∞–º–∏ –¢–∞—Ä–æ."},
            {"role": "user", "content": prompt}
        ],
        temperature=0.8,
        max_tokens=500
    )
    
    return response.choices[0].message.content.strip()


def generate_tarot_reading(question: str, cards: list, spread_type: str):
    """Generate tarot reading based on question and cards drawn"""
    
    if spread_type == "1_card":
        prompt = f"""–¢—ã ‚Äî –º—è–≥–∫–∏–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –≥–∏–¥ –¥–ª—è –∂–µ–Ω—â–∏–Ω. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å: "{question}"

–í—ã–ø–∞–ª–∞ –∫–∞—Ä—Ç–∞: ¬´{cards[0]}¬ª

–°–æ–∑–¥–∞–π –æ—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ:

üÉè –û—Ç–≤–µ—Ç –¢–∞—Ä–æ

–ö–∞—Ä—Ç–∞: ¬´{cards[0]}¬ª
–°–º—ã—Å–ª: [–∫–æ—Ä–æ—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –≤–æ–ø—Ä–æ—Å–∞]

‚ú® –ú—è–≥–∫–∏–π —Å–æ–≤–µ—Ç: [1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ]

–í–æ–ø—Ä–æ—Å –¥–ª—è –¥–Ω–µ–≤–Ω–∏–∫–∞: [1 —Ä–µ—Ñ–ª–µ–∫—Å–∏–≤–Ω—ã–π –≤–æ–ø—Ä–æ—Å]

–¢–æ–Ω: —Ç—ë–ø–ª—ã–π, –∂–µ–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π, –±–µ–∑ —Å—Ç—Ä–∞—Ö–∞ –∏ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π. –ü–æ–º–Ω–∏: —Ç—ã –ø–æ–º–æ–≥–∞–µ—à—å —É—Å–ª—ã—à–∞—Ç—å —Å–µ–±—è, –∞ –Ω–µ –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—à—å —Å—É–¥—å–±—É."""

    else:  # 3_cards
        prompt = f"""–¢—ã ‚Äî –º—è–≥–∫–∏–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –≥–∏–¥ –¥–ª—è –∂–µ–Ω—â–∏–Ω. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å: "{question}"

–í—ã–ø–∞–ª–∏ –∫–∞—Ä—Ç—ã:
1Ô∏è‚É£ –ü—Ä–æ—à–ª–æ–µ ‚Äî ¬´{cards[0]}¬ª
2Ô∏è‚É£ –ù–∞—Å—Ç–æ—è—â–µ–µ ‚Äî ¬´{cards[1]}¬ª
3Ô∏è‚É£ –ë—É–¥—É—â–µ–µ ‚Äî ¬´{cards[2]}¬ª

–°–æ–∑–¥–∞–π –æ—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ:

üÉè –†–∞—Å–∫–ª–∞–¥ –¢–∞—Ä–æ

1Ô∏è‚É£ –ü—Ä–æ—à–ª–æ–µ ‚Äî ¬´{cards[0]}¬ª
[–∫–æ—Ä–æ—Ç–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ]

2Ô∏è‚É£ –ù–∞—Å—Ç–æ—è—â–µ–µ ‚Äî ¬´{cards[1]}¬ª
[–∫–æ—Ä–æ—Ç–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ]

3Ô∏è‚É£ –ë—É–¥—É—â–µ–µ ‚Äî ¬´{cards[2]}¬ª
[–∫–æ—Ä–æ—Ç–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ]

‚ú® –ò—Ç–æ–≥: [1 —Å–ø–æ–∫–æ–π–Ω–æ–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ]

–í–æ–ø—Ä–æ—Å –¥–ª—è –¥–Ω–µ–≤–Ω–∏–∫–∞: [1 —Ä–µ—Ñ–ª–µ–∫—Å–∏–≤–Ω—ã–π –≤–æ–ø—Ä–æ—Å]

–¢–æ–Ω: —Ç—ë–ø–ª—ã–π, –∂–µ–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π, –±–µ–∑ —Å—Ç—Ä–∞—Ö–∞ –∏ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π. –ü–æ–º–Ω–∏: —Ç—ã –ø–æ–º–æ–≥–∞–µ—à—å —É—Å–ª—ã—à–∞—Ç—å —Å–µ–±—è, –∞ –Ω–µ –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—à—å —Å—É–¥—å–±—É."""

    response = client.chat.completions.create(
        model="gpt-4.1-mini",
        messages=[
            {"role": "system", "content": "–¢—ã ‚Äî –º—è–≥–∫–∏–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –≥–∏–¥, –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É—é—â–∏–π –∫–∞—Ä—Ç—ã –¢–∞—Ä–æ."},
            {"role": "user", "content": prompt}
        ],
        temperature=0.8,
        max_tokens=800
    )
    
    return response.choices[0].message.content.strip()


def generate_own_deck_reading(question: str, cards: list, spread_type: str):
    """Generate reading for user's own deck"""
    
    cards_text = "\n".join([f"{i+1}. ¬´{card}¬ª" for i, card in enumerate(cards)])
    
    if spread_type == "1_card":
        layout_desc = "1 –∫–∞—Ä—Ç–∞ ‚Äî —Å–æ–≤–µ—Ç"
    elif spread_type == "2_cards":
        layout_desc = "2 –∫–∞—Ä—Ç—ã ‚Äî —Å–∏—Ç—É–∞—Ü–∏—è"
    else:
        layout_desc = "3 –∫–∞—Ä—Ç—ã ‚Äî –ø—Ä–æ—à–ª–æ–µ / –Ω–∞—Å—Ç–æ—è—â–µ–µ / –±—É–¥—É—â–µ–µ"
    
    prompt = f"""–¢—ã ‚Äî –º—è–≥–∫–∏–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –≥–∏–¥ –¥–ª—è –∂–µ–Ω—â–∏–Ω. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—Ç—è–Ω—É–ª –∫–∞—Ä—Ç—ã –∏–∑ —Å–≤–æ–µ–π –∫–æ–ª–æ–¥—ã.

–í–æ–ø—Ä–æ—Å: "{question}"
–†–∞—Å–∫–ª–∞–¥: {layout_desc}

–ö–∞—Ä—Ç—ã:
{cards_text}

–û–±—ä—è—Å–Ω–∏ –∫–∞–∂–¥—É—é –∫–∞—Ä—Ç—É –∫—Ä–∞—Ç–∫–æ –∏ –º—è–≥–∫–æ. –ó–∞–∫–æ–Ω—á–∏ –≤–æ–ø—Ä–æ—Å–æ–º –¥–ª—è –¥–Ω–µ–≤–Ω–∏–∫–∞.

–¢–æ–Ω: —Ç—ë–ø–ª—ã–π, –∂–µ–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π, –±–µ–∑ —Å—Ç—Ä–∞—Ö–∞ –∏ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π. –ü–æ–º–Ω–∏: —Ç—ã –ø–æ–º–æ–≥–∞–µ—à—å —É—Å–ª—ã—à–∞—Ç—å —Å–µ–±—è, –∞ –Ω–µ –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—à—å —Å—É–¥—å–±—É."""

    response = client.chat.completions.create(
        model="gpt-4.1-mini",
        messages=[
            {"role": "system", "content": "–¢—ã ‚Äî –º—è–≥–∫–∏–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –≥–∏–¥, –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É—é—â–∏–π –∫–∞—Ä—Ç—ã –¢–∞—Ä–æ."},
            {"role": "user", "content": prompt}
        ],
        temperature=0.8,
        max_tokens=800
    )
    
    return response.choices[0].message.content.strip()


def generate_deeper_interpretation(original_reading: str, user_question: str = ""):
    """Generate deeper interpretation for paid users"""
    
    prompt = f"""–¢—ã ‚Äî –º—è–≥–∫–∏–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –≥–∏–¥ –¥–ª—è –∂–µ–Ω—â–∏–Ω. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç —É–≥–ª—É–±–∏—Ç—å –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Ä–∞—Å–∫–ª–∞–¥–∞.

–ò—Å—Ö–æ–¥–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥:
{original_reading}

–°–æ–∑–¥–∞–π –±–æ–ª–µ–µ –≥–ª—É–±–æ–∫—É—é –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é:
- –î–æ–±–∞–≤—å –Ω—é–∞–Ω—Å—ã –∏ –¥–µ—Ç–∞–ª–∏
- –ü—Ä–µ–¥–ª–æ–∂–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è
- –î–∞–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

–¢–æ–Ω: —Ç—ë–ø–ª—ã–π, –∂–µ–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π, –±–µ–∑ —Å—Ç—Ä–∞—Ö–∞ –∏ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π."""

    response = client.chat.completions.create(
        model="gpt-4.1-mini",
        messages=[
            {"role": "system", "content": "–¢—ã ‚Äî –º—è–≥–∫–∏–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –≥–∏–¥, —Å–æ–∑–¥–∞—é—â–∏–π –≥–ª—É–±–æ–∫–∏–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ –¢–∞—Ä–æ."},
            {"role": "user", "content": prompt}
        ],
        temperature=0.8,
        max_tokens=1000
    )
    
    return response.choices[0].message.content.strip()
